language: shell
before_install:
 - sudo add-apt-repository ppa:rmescandon/yq -y
 - sudo apt update
 - sudo apt install yq -y
jobs:
  include:
   - stage: package
     script: ./ci/package.sh $PUBLISH_DIR ${TRAVIS_BRANCH}
   - stage: index
     script: ./ci/index.sh ./ ${REPO_URL}
stages:
  - package
    if: ${TRAVIS_BRANCH} != publish
  - index
    if: ${TRAVIS_BRANCH} = publish
env:
  global:
    PUBLISH_DIR: publish
    REPO_URL: https://ibm-garage-cloud.github.io/garage-pipelines
deploy:
- provider: pages
  skip_cleanup: true
  github_url: github.com
  github_token: $GITHUB_TOKEN
  keep_history: false
  local_dir: ./
  on:
    branch: publish1
- provider: pages
  skip_cleanup: true
  github_url: github.com
  github_token: $GITHUB_TOKEN
  keep_history: true
  target_branch: publish
  local_dir: $PUBLISH_DIR
  on:
    all_branches: true
    condition: ${TRAVIS_BRANCH} != "publish"
